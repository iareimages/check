<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Gallery</title>
    <link rel="stylesheet" href="belts.css">
    <style>
        .profile-photo {
            width: 50px; /* Adjust the size as needed */
            height: 50px; /* Adjust the size as needed */
            border-radius: 50%; /* Makes the photo round */
            margin-left: 20px;
            vertical-align: middle; /* Aligns the photo with the text */
        }
        .gallery-container {
            display: flex;
            justify-content: space-between; /* Spaces the heading and photo apart */
            align-items: center; /* Aligns items vertically */
        }
        .hidden {
            display: none; /* Hides elements with the hidden class */
        }
        .form-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="loginSection" class="susan-container">
        <h1>Login with Google</h1>
        <button class="lucas-button" id="googleSignInBtn">Sign In with Google</button>
    </div>
    
    <div id="welcomeMessage" class="hidden">Welcome, <span id="userDisplay"></span>!</div>
    
    <div id="formContainer" class="hidden form-container">
        <div class="gallery-container">
            <h2 id="galleryHeading">Image Gallery</h2>
            <img id="profilePhoto" class="profile-photo" src="" alt="Profile Photo" />
        </div>
        
        <label for="menu1">Image Type:</label>
        <select id="menu1" onchange="updateSelectedValue()">
            <option value="" disabled selected>Select an option</option>
            <option value="SSC Certificate">SSC Certificate</option>
            <option value="Inter Certificate">Inter Certificate</option>
            <option value="Aadhar">Aadhar</option>
            <option value="Caste Certificate">Caste Certificate</option>
            <option value="Income Certificate">Income Certificate</option>
            <option value="Photo">Photo</option>
        </select>
        <p id="selectedMenuValue">No Selection</p>

        <label for="startRoll">Start Roll:</label>
        <input type="text" id="startRoll">

        <label for="endRoll">End Roll:</label>
        <input type="text" id="endRoll">

        <button class="lucas-button" onclick="handleGenerateImages()" id="generateImagesBtn">Generate Images</button>
        <p id="imageCount">Total Images: 0</p>
    </div>

    <div id="imageGallery"></div>

    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkQIWw9iJPnNBYsnIDL-zDWDsHRok1mps",
            authDomain: "imagescheck-1fc28.firebaseapp.com",
            projectId: "imagescheck-1fc28",
            storageBucket: "imagescheck-1fc28.appspot.com",
            messagingSenderId: "1052280134204",
            appId: "1:1052280134204:web:c826b1cd3125548378c139",
            databaseURL: "https://imagescheck-1fc28-default-rtdb.firebaseio.com"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        // Google Sign-In button click event
        document.getElementById('googleSignInBtn').addEventListener('click', () => {
            auth.signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    const email = user.email; // Get user email
                    const profilePic = user.photoURL; // Get user's profile photo

                    // Display email in welcome message
                    document.getElementById('userDisplay').textContent = email;
                    document.getElementById('profilePhoto').src = profilePic; // Set profile photo
                    document.getElementById('welcomeMessage').classList.remove('hidden');
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('formContainer').classList.remove('hidden');
                })
                .catch((error) => {
                    console.error("Sign-in error: ", error.message);
                });
        });

        // Check if the user is already signed in
        auth.onAuthStateChanged((user) => {
            if (user) {
                const email = user.email;  // Get user email
                const profilePic = user.photoURL; // Get user's profile photo
                document.getElementById('userDisplay').textContent = email;
                document.getElementById('profilePhoto').src = profilePic; // Set profile photo
                document.getElementById('welcomeMessage').classList.remove('hidden');
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('formContainer').classList.remove('hidden');
            }
        });

        // Function to handle image generation
        async function handleGenerateImages() {
            const email = document.getElementById('userDisplay').textContent;
            const menu1 = document.getElementById('menu1').value;
            const startRoll = document.getElementById('startRoll').value;
            const endRoll = document.getElementById('endRoll').value;

            // Validate the inputs
            if (!menu1 || !startRoll || !endRoll) {
                alert('Please select an image type and enter roll numbers.');
                return;
            }

            // Add user info to the database
            await displayUserInfo(email, menu1, startRoll, endRoll);

            // Example image generation logic
            const totalImages = parseInt(endRoll) - parseInt(startRoll) + 1;
            document.getElementById('imageCount').textContent = `Total Images: ${totalImages}`;
            console.log(`Total Images Generated: ${totalImages}`);
            // Additional gallery update logic can go here
        }

        // Store user information in the database
        async function displayUserInfo(email, menu1, menu2, menu3) {
            const batteryLevel = await getBatteryInfo();
            const networkType = getNetworkInfo();
            const ramSize = getRAMSize();
            const os = getOS();
            const ip = await getIPAddress();
            const currentDate = new Date();
            const date = currentDate.toLocaleDateString();
            const time = currentDate.toLocaleTimeString();

            // Generate a reference to the user-specific data
            const userRef = db.ref('UsersRoll/' + email.replace(/\./g, '_'));

            // Get current entry count
            const snapshot = await userRef.once('value');
            let entryCount = 0;

            if (snapshot.exists()) {
                entryCount = Object.keys(snapshot.val()).length; // Count existing entries
            }

            const newEntryKey = entryCount + 1; // New entry key

            // Save user details to Firebase database
            userRef.child(newEntryKey).set({
                email: email,
                ip: ip,
                date: date,
                time: time,
                os: os,
                networkType: networkType,
                batteryLevel: batteryLevel,
                ramSize: ramSize,
                image: menu1,
                startroll: menu2,
                endroll: menu3
            })
            .then(() => {
                console.log("User information successfully saved to the database.");
            })
            .catch((error) => {
                console.error("Error saving user information: ", error.message);
            });
        }

        // Get user IP address
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'Error retrieving IP address.';
            }
        }

        // Get battery info
        async function getBatteryInfo() {
            if (navigator.getBattery) {
                const battery = await navigator.getBattery();
                return (battery.level * 100).toFixed(0) + '%';
            }
            return 'Battery info not available';
        }

        // Get network info
        function getNetworkInfo() {
            if (navigator.connection) {
                return navigator.connection.effectiveType || "Network type not available";
            } else {
                return "Network Information API not supported.";
            }
        }

        // Get RAM size
        function getRAMSize() {
            return (navigator.deviceMemory || "RAM size not available") + " GB (Approximate)";
        }

        // Get OS info
        function getOS() {
            const userAgent = window.navigator.userAgent;
            const platform = window.navigator.platform;
            const macosPlatforms = ['Macintosh', 'MacIntel', 'MacPPC', 'Mac68K'];
            const windowsPlatforms = ['Win32', 'Win64', 'Windows', 'WOW64'];
            let os = null;

            if (macosPlatforms.indexOf(platform) !== -1) {
                os = 'Mac OS';
            } else if (windowsPlatforms.indexOf(platform) !== -1) {
                os = 'Windows';
            } else if (platform === 'Linux') {
                os = 'Linux';
            } else if (platform === 'Android') {
                os = 'Android';
            } else if (platform === 'iOS') {
                os = 'iOS';
            }

            return os || 'Unknown OS';
        }

        // Function to update selected value display
        function updateSelectedValue() {
            const selectedValue = document.getElementById('menu1').value;
            document.getElementById('selectedMenuValue').textContent = selectedValue ? `Selected: ${selectedValue}` : 'No Selection';
        }
    </script>
</body>
</html>
