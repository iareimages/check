<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Gallery</title>
    <link rel="stylesheet" href="belts.css">
    <style>
        /* Add some simple styles for the profile picture */
        #profilePicture {
            margin-bottom: -15px;
            margin-top: 26px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: none; /* Hide by default */
        }
    </style>
</head>
<body>
    <div id="johnSection" class="susan-container">
        <h1>Sign in with Google</h1>
        <button class="lucas-button" id="googleSignInBtn">Sign in with Google</button>
        <center>
            <div class="ddess" id="johnSection">
                <h3>Please wait... <br><br>If you already signed in once it will automatically load. If not, please login by <strong><i>clicking the above button</i></strong></h3>
            </div>
        </center>
    </div>
    
    <div id="aliceMessage" class="hidden">Welcome, <span id="jamesDisplay"></span>!</div>
    <img id="profilePicture" alt="Profile Picture">
    <div id="hide" class="hide form-container">
        <h2>Generate Images</h2>
        <label for="menu1">Image Type:</label>
        <select id="menu1" onchange="updateSelectedValue()">
            <option value="" disabled selected>Select an option</option>
            <option value="SSC Certificate">SSC Certificate</option>
            <option value="Inter Certificate">Inter Certificate</option>
            <option value="Aadhar">Aadhar</option>
            <option value="Caste Certificate">Caste Certificate</option>
            <option value="Income Certificate">Income Certificate</option>
            <option value="Photo">Photo</option>
        </select>
        <p id="selectedMenuValue">No Selection</p>

        <label for="startRoll">Start Roll:</label>
        <input type="text" id="startRoll">

        <label for="endRoll">End Roll:</label>
        <input type="text" id="endRoll">

        <button class="lucas-button" id="che">Generate Images</button>
        <p id="imageCount">Total Images: 0</p>
    </div>

    <div id="imageGallery"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCkQIWw9iJPnNBYsnIDL-zDWDsHRok1mps",
            authDomain: "imagescheck-1fc28.firebaseapp.com",
            projectId: "imagescheck-1fc28",
            storageBucket: "imagescheck-1fc28.appspot.com",
            messagingSenderId: "1052280134204",
            appId: "1:1052280134204:web:c826b1cd3125548378c139",
            databaseURL: "https://imagescheck-1fc28-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        document.addEventListener("DOMContentLoaded", function() {
            const profilePicture = document.getElementById('profilePicture');
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            const cheBtn = document.getElementById('che');

            // Check if user is signed in when the page loads
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const email = user.email;
                    const profilePicUrl = user.photoURL; // Get the profile picture URL
                    
                    if (profilePicture) {
                        profilePicture.src = profilePicUrl; // Set the profile picture source
                        profilePicture.style.display = "block"; // Show the profile picture
                    }
                    document.getElementById("jamesDisplay").textContent = email;
                    document.getElementById("aliceMessage").classList.remove("hidden");
                    document.getElementById("johnSection").style.display = "none";
                    document.getElementById("hide").style.display = "block";
                } else {
                    document.getElementById("johnSection").style.display = "block";
                    document.getElementById("hide").style.display = "none";
                }
            });

            googleSignInBtn.addEventListener("click", signInWithGoogle);

            cheBtn.addEventListener("click", addDb);
        });

        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const email = user.email;
                const profilePicUrl = user.photoURL;

                document.getElementById("jamesDisplay").textContent = email;
                const profilePicture = document.getElementById('profilePicture');
                if (profilePicture) {
                    profilePicture.src = profilePicUrl;
                    profilePicture.style.display = "block";
                }
                document.getElementById("aliceMessage").classList.remove("hidden");
                document.getElementById("johnSection").style.display = "none";
                document.getElementById("hide").style.display = "block";

                await displayUserInfo(email);
            } catch (error) {
                console.error("Error signing in with Google: ", error);
            }
        }

        function sanitizeKey(input) {
            return input.replace(/[.\$#\[\]\/]/g, '_');
        }

        async function displayUserInfo(email) {
            const sanitizedEmail = sanitizeKey(email);
            const batteryLevel = await getBatteryInfo();
            const networkType = getNetworkInfo();
            const ramSize = getRAMSize();
            const os = getOS();
            const ip = await getIPAddress();
            const currentDate = new Date();
            const date = currentDate.toLocaleDateString();
            const time = currentDate.toLocaleTimeString();
            const menu1 = sanitizeKey(document.getElementById('menu1').value);
            const menu2 = sanitizeKey(document.getElementById('startRoll').value); 
            const menu3 = sanitizeKey(document.getElementById('endRoll').value); 
            await generateImages(menu2,menu3);
            const nextIndex = await getNextIndex(sanitizedEmail);
            await set(ref(db, 'UsersRoll/' + sanitizedEmail + '/' + nextIndex), {
                email: sanitizedEmail,
                ip: ip,
                date: date,
                time: time,
                os: os,
                networkType: networkType,
                batteryLevel: batteryLevel,
                ramSize: ramSize,
                image: menu1,
                startroll: menu2,
                endroll: menu3
            });
        }

        async function getNextIndex(email) {
            const dbRef = ref(db);
            const snapshot = await get(child(dbRef, 'UsersRoll/' + email));
            if (snapshot.exists()) {
                const data = snapshot.val();
                return Object.keys(data).length + 1;
            } else {
                return 1;
            }
        }

        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'Error retrieving IP address.';
            }
        }

        function getBatteryInfo() {
            return navigator.getBattery().then(function(battery) {
                return (battery.level * 100).toFixed(0) + '%';
            });
        }

        function getNetworkInfo() {
            if (navigator.connection) {
                return navigator.connection.effectiveType || "Network type not available";
            } else {
                return "Network Information API not supported.";
            }
        }

        function getRAMSize() {
            return (navigator.deviceMemory || "RAM size not available") + " GB (Approximate)";
        }

        function getOS() {
            const userAgent = window.navigator.userAgent;
            const platform = window.navigator.platform;
            const macosPlatforms = ['Macintosh', 'MacIntel', 'MacPPC', 'Mac68K'];
            const windowsPlatforms = ['Win32', 'Win64', 'Windows', 'WinCE'];
            const iosPlatforms = ['iPhone', 'iPad', 'iPod'];

            if (macosPlatforms.includes(platform)) {
                return 'macOS';
            } else if (iosPlatforms.includes(platform)) {
                return 'iOS';
            } else if (windowsPlatforms.includes(platform)) {
                return 'Windows';
            } else if (/Android/.test(userAgent)) {
                return 'Android';
            } else if (!os && /Linux/.test(platform)) {
                return 'Linux';
            }

            return "Unknown OS";
        }

        function updateSelectedValue() {
            const menu1 = document.getElementById('menu1').value;
            document.getElementById('selectedMenuValue').textContent = menu1;
        }

        function addDb() {
            console.log("Database entry function triggered");
        }
        async function generateImages(rollNumber1, rollNumber2) {
            const startRoll = parseInt(rollNumber1);
            const endRoll = parseInt(rollNumber2);

            const container = document.getElementById('imageGallery');
            container.innerHTML = '';
            const imageCountDiv = document.getElementById('imageCount');
            imageCountDiv.textContent = '';

            if (!isNaN(startRoll) && !isNaN(endRoll) && startRoll <= endRoll) {
                for (let i = startRoll; i <= endRoll; i++) {
                    const imgItem = document.createElement('div');
                    imgItem.className = 'imageItem';
                    const imgUrl = `https://www.mruexams.com/SBCMSSTUDENT/Frm_StudentPhoto.aspx?StudentCode=${i}`;
                    const img = document.createElement('img');
                    img.src = imgUrl;
                    img.alt = `Displayed Image with Roll Number: ${i}`;
                    img.title = `Roll Number: ${i}`;
                    imgItem.appendChild(img);
                    const rollNumberDiv = document.createElement('div');
                    rollNumberDiv.className = 'rollNumber';
                    rollNumberDiv.textContent = `${i}`;
                    imgItem.appendChild(rollNumberDiv);
                    container.appendChild(imgItem);
                }
                imageCountDiv.textContent = `Total Images Displayed: ${endRoll - startRoll + 1}`;
            } else {
                alert('Please enter valid roll numbers.');
            }
        }
    </script>
</body>
</html>
